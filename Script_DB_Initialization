CREATE DATABASE posappdb;
CREATE USER posappusr IDENTIFIED BY 'GNEMOBY';
GRANT SELECT, INSERT, UPDATE, DELETE ON `posappdb`.* TO posappusr;
GRANT LOCK TABLES ON `posappdb`.* TO posappusr;

-- sbxnexidb.SPRING_SESSION definition

CREATE TABLE `SPRING_SESSION` (
  `PRIMARY_ID` char(36) NOT NULL,
  `SESSION_ID` char(36) NOT NULL,
  `CREATION_TIME` bigint NOT NULL,
  `LAST_ACCESS_TIME` bigint NOT NULL,
  `MAX_INACTIVE_INTERVAL` int NOT NULL,
  `EXPIRY_TIME` bigint NOT NULL,
  `PRINCIPAL_NAME` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`PRIMARY_ID`),
  UNIQUE KEY `SPRING_SESSION_IX1` (`SESSION_ID`),
  KEY `SPRING_SESSION_IX2` (`EXPIRY_TIME`),
  KEY `SPRING_SESSION_IX3` (`PRINCIPAL_NAME`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;

-- sbxnexidb.SPRING_SESSION_ATTRIBUTES definition

CREATE TABLE `SPRING_SESSION_ATTRIBUTES` (
  `SESSION_PRIMARY_ID` char(36) NOT NULL,
  `ATTRIBUTE_NAME` varchar(200) NOT NULL,
  `ATTRIBUTE_BYTES` blob NOT NULL,
  PRIMARY KEY (`SESSION_PRIMARY_ID`,`ATTRIBUTE_NAME`),
  CONSTRAINT `SPRING_SESSION_ATTRIBUTES_FK` FOREIGN KEY (`SESSION_PRIMARY_ID`) REFERENCES `SPRING_SESSION` (`PRIMARY_ID`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci ROW_FORMAT=DYNAMIC;


CREATE TABLE `USER` (
  `pk_user` VARCHAR(50) PRIMARY KEY,
  `first_name` VARCHAR(255),
  `last_name` VARCHAR(255),
  `email` VARCHAR(255),
  `company` VARCHAR(255),
  `office` VARCHAR(255),
  `last_logged_in` DATETIME
) ENGINE=InnoDB;

CREATE TABLE `AUTHORITY` (
  `pk_authority` VARCHAR(50) PRIMARY KEY,
  `description` VARCHAR(255)
) ENGINE=InnoDB;

CREATE TABLE `USER_AUTHORITY` (
  `fk_user` VARCHAR(50),
  `fk_authority` VARCHAR(50),
  PRIMARY KEY (`fk_user`, `fk_authority`),
  FOREIGN KEY (`fk_user`) REFERENCES `USER`(`pk_user`),
  FOREIGN KEY (`fk_authority`) REFERENCES `AUTHORITY`(`pk_authority`)
) ENGINE=InnoDB;


CREATE TABLE `PERIOD` (
  `pk_period` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(50),
  `description` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

CREATE TABLE `OBBLIGATION` (
  `pk_obbligation` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_period` BIGINT,
  `fiscalYear` INT,
  FOREIGN KEY (`fk_period`) REFERENCES `PERIOD`(`pk_period`)
) ENGINE=InnoDB;

CREATE TABLE `SUBMISSION_STATUS` (
  `pk_submission_status` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `code` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

CREATE TABLE `SUBMISSION_TYPE` (
  `pk_submission_type` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

CREATE TABLE `SUBMISSION` (
  `pk_submission` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_current_submission_status` BIGINT,
  `fk_last_update_by` VARCHAR(50),
  `fk_obbligation` BIGINT,
  `fk_submission_type` BIGINT,
  `last_updated_at` DATETIME,
  `approved_at` DATETIME,
  `deadline_date` DATE,
  `batch_id` VARCHAR(100),
  `is_manual` BOOLEAN,
  `fk_lastStatusBeforeCancel` BIGINT,
  `cancelled_at` DATETIME,
  FOREIGN KEY (`fk_current_submission_status`) REFERENCES `SUBMISSION_STATUS`(`pk_submission_status`),
  FOREIGN KEY (`fk_last_update_by`) REFERENCES `USER`(`pk_user`),
  FOREIGN KEY (`fk_submission_type`) REFERENCES `SUBMISSION_TYPE`(`pk_submission_type`),
  FOREIGN KEY (`fk_obbligation`) REFERENCES `OBBLIGATION`(`pk_obbligation`),
  FOREIGN KEY (`fk_lastStatusBeforeCancel`) REFERENCES `SUBMISSION_STATUS`(`pk_submission_status`)
) ENGINE=InnoDB;

CREATE TABLE `INGESTION_TYPE` (
  `pk_ingestion_type` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

CREATE TABLE `INGESTION_STATUS` (
  `pk_ingestion_status` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

CREATE TABLE `INGESTION_ERROR` (
  `pk_ingestion_error` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `order` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;


CREATE TABLE `INGESTION` (
  `pk_ingestion` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_ingestion_type` BIGINT,
  `fk_ingestion_status` BIGINT,
  `fk_submission` BIGINT,
  `fk_ingestion_error` BIGINT,

  `ingested_at` DATETIME,
--   `total_transactions` INT,
--   `total_reportable_transactions` INT,

--   `batch_id` BIGINT,
  `full_path` VARCHAR(255) COMMENT 'Full path on bucket S3 or remote folder where this file originated from',

  FOREIGN KEY (`fk_ingestion_type`) REFERENCES `INGESTION_TYPE`(`pk_ingestion_type`),
  FOREIGN KEY (`fk_ingestion_status`) REFERENCES `INGESTION_STATUS`(`pk_ingestion_status`),
  FOREIGN KEY (`fk_submission`) REFERENCES `SUBMISSION`(`pk_submission`),
  FOREIGN KEY (`fk_ingestion_error`) REFERENCES `INGESTION_ERROR`(`pk_ingestion_error`)

) ENGINE=InnoDB;


CREATE TABLE `OUTPUT_FILE` (
  `pk_output` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_submission` BIGINT,
  `full_path` VARCHAR(255) COMMENT 'Full path on bucket S3 or remote folder where this file is uploaded',
  `extention_type` VARCHAR(255),
  `generated_at` VARCHAR(255),
  FOREIGN KEY (`fk_submission`) REFERENCES `SUBMISSION`(`pk_submission`)
) ENGINE=InnoDB;

CREATE TABLE `ERROR_TYPE` (
  `pk_error_type` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `name` VARCHAR(255),
  `description` VARCHAR(255),
  `serverity_level` INT,
  `is_active` BOOLEAN
) ENGINE=InnoDB;

-- CREATE TABLE `CURRENCY` (
--   `pk_currency` BIGINT PRIMARY KEY AUTO_INCREMENT,
--   `name` VARCHAR(255),
--   `code` VARCHAR(255),
--   `description` VARCHAR(255),
--   `order` INT,
--   `is_active` BOOLEAN
-- ) ENGINE=InnoDB;

CREATE TABLE `LOG` (
  `pk_log` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_sbmission` BIGINT,
  `fk_updater` VARCHAR(50),
  `fk_before_sumbission_status` BIGINT,
  `fk_after_sumbission_status` BIGINT,
  `timestamp` datetime,
  `message` VARCHAR(255),
  FOREIGN KEY (`fk_sbmission`) REFERENCES `SUBMISSION`(`pk_submission`),
  FOREIGN KEY (`fk_updater`) REFERENCES `USER`(`pk_user`),
  FOREIGN KEY (`fk_before_sumbission_status`) REFERENCES `SUBMISSION_STATUS`(`pk_submission_status`),
  FOREIGN KEY (`fk_after_sumbission_status`) REFERENCES `SUBMISSION_STATUS`(`pk_submission_status`)
) ENGINE=InnoDB;


CREATE TABLE `MERCHANT` (
  `pk_merchant` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_ingestion` BIGINT,
  `tp_rec` VARCHAR(1),
  `id_intermediario` VARCHAR(11),
  `id_esercente` VARCHAR(30),
  `cod_fiscale` VARCHAR(16),
  `partita_iva` VARCHAR(11),
  UNIQUE KEY unique_esercente_intermediario (`id_esercente`, `id_intermediario`)
) ENGINE=InnoDB;

CREATE TABLE `MERCHANT_ACCOUNT` (
  `pk_merchant_account` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_ingestion` BIGINT,
  `tp_rec` VARCHAR(1),
  `id_intermediario` VARCHAR(11),
  `chiave_banca` varchar(50),

  UNIQUE KEY unique_intermediario_chiaveBanca (`id_intermediario`, `chiave_banca`)
) ENGINE=InnoDB;

CREATE TABLE `TRANSACTION` (
  `pk_transaction` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_ingestion` BIGINT,
--   `fk_transaction_error` BIGINT,
--   `error_message` VARCHAR(2500)
  `tp_rec` VARCHAR(1),
  `id_intermediario` varchar(11),
  `id_esercente` varchar(30),
  `chiave_banca` varchar(50),
  `id_pos` varchar(30),
  `tipo_ope` varchar(2),
  `dt_ope` INT,
  `divisa_ope` varchar(3),
  `tipo_pag` varchar(2),
  `imp_ope` decimal(14,2),
  `tot_ope` INT,
  FOREIGN KEY (`fk_ingestion`) REFERENCES `INGESTION`(`pk_ingestion`),
--   FOREIGN KEY (`fk_transaction_error`) REFERENCES `TRANSACTION_ERROR`(`pk_transaction_error`),
  UNIQUE KEY transaction_unique (id_esercente, chiave_banca, id_pos, tipo_ope, dt_ope, divisa_ope),

  CONSTRAINT fk_esercente_intermediario FOREIGN KEY (`id_esercente`, `id_intermediario`) REFERENCES MERCHANT(`id_esercente`, `id_intermediario`),
  CONSTRAINT fk_intermediario_chiaveBanca FOREIGN KEY (`id_intermediario`, `chiave_banca`) REFERENCES MERCHANT_ACCOUNT(`id_intermediario`, `chiave_banca`)
) ENGINE=InnoDB;

ALTER TABLE TRANSACTION
ADD COLUMN fk_output BIGINT NULL,
ADD CONSTRAINT OUTPUT_FK
    FOREIGN KEY (fk_output)
    REFERENCES OUTPUT_FILE(pk_output);

ALTER TABLE `TRANSACTION`
ADD COLUMN created_at DATETIME NULL;

-- Join table not for just for 1:N relation (actually, the relation may be N:1, that is 1 error per transacition at most), but for performance improvement and space allocation ottimization, due to the error message 2500
CREATE TABLE `ERROR_RECORD` (
	`pk_error_record` BIGINT PRIMARY KEY AUTO_INCREMENT,
	`fk_ingestion` BIGINT,
	`fk_error_type` BIGINT NOT NULL,
	`error_message` VARCHAR(2500),
	`raw_row` VARCHAR(250),

	FOREIGN KEY (`fk_ingestion`) REFERENCES `INGESTION`(`pk_ingestion`),
	FOREIGN KEY (fk_error_type) REFERENCES `ERROR_TYPE`(pk_error_type)
)

CREATE TABLE MONTHLY_OUTPUT (
  pk_monthly_output BIGINT AUTO_INCREMENT PRIMARY KEY,
  tp_rec VARCHAR(1),
  cf_sogg_obbligato VARCHAR(16),
  tipo_ope VARCHAR(2),
  dt_ope INT,
  tot_ope INT,
  imp_ope DECIMAL(14,2),
  divisa_ope VARCHAR(3),
  id_esercente VARCHAR(30),
  id_pos VARCHAR(30),
  tipo_pag VARCHAR(2),
  cod_fiscale VARCHAR(16),
  partita_iva VARCHAR(11),
  chiave_banca VARCHAR(50)
);

CREATE TABLE CONSISTENCY_OUTPUT (
  pk_consistency_output BIGINT AUTO_INCREMENT PRIMARY KEY,
  tp_rec VARCHAR(1),
  cf_sogg_obbligato VARCHAR(16) COMMENT 'Codice Fiscale del soggetto obbligato alla comunicazione - Acquirer',
  tipo_ope VARCHAR(2),
  mese_ope INT,
  anno_ope INT,
  imp_ope DECIMAL(14,2),
  tot_ope INT,
  id_esercente VARCHAR(30),
  id_pos VARCHAR(30),
  tipo_pag VARCHAR(2),
  cod_fiscale VARCHAR(16),
  partita_iva VARCHAR(11),
  chiave_banca VARCHAR(50)
);

create table SUBMISSION_STATUS_GROUP (
    pk_submission_status_group bigint not null auto_increment,
    name varchar(255),
    description varchar(255),
    code varchar(255),
    `order` integer,
    is_active bit,
    primary key (pk_submission_status_group)
);

ALTER TABLE SUBMISSION_STATUS
ADD COLUMN fk_submission_status_group BIGINT;

ALTER TABLE SUBMISSION_STATUS
ADD CONSTRAINT SUBMISSION_STATUS_GROUP_FK
FOREIGN KEY (fk_submission_status_group)
REFERENCES SUBMISSION_STATUS_GROUP (pk_submission_status_group);

ALTER TABLE SUBMISSION
ADD COLUMN fk_submission_status BIGINT;

ALTER TABLE SUBMISSION
ADD CONSTRAINT SUBMISSION_STATUS_FK
FOREIGN KEY (fk_submission_status)
REFERENCES SUBMISSION_STATUS  (pk_submission_status);

ALTER TABLE SUBMISSION
ADD COLUMN cancelled_at DATETIME NULL

ALTER TABLE ERROR_TYPE
ADD COLUMN error_code varchar(255) NULL

ALTER TABLE ERROR_RECORD
ADD COLUMN created_at DATETIME NULL;

ALTER TABLE MERCHANT
ADD COLUMN created_at DATETIME NULL;

ALTER TABLE MERCHANT
ADD COLUMN id_salmov VARCHAR(50) NULL;

ALTER TABLE TRANSACTION
MODIFY COLUMN dt_ope VARCHAR(8) NULL;

ALTER TABLE MERCHANT
ADD COLUMN fk_submission BIGINT NULL,
ADD CONSTRAINT MERCHANT_SUBMISSION_FK
FOREIGN KEY (fk_submission) REFERENCES SUBMISSION(pk_submission)
ON DELETE RESTRICT;

UPDATE MERCHANT m
JOIN INGESTION i ON m.fk_ingestion  = i.pk_ingestion
SET m.fk_submission = i.fk_submission ;

ALTER TABLE TRANSACTION
ADD COLUMN fk_submission BIGINT NULL,
ADD CONSTRAINT TRANSACTION_SUBMISSION_FK
FOREIGN KEY (fk_submission) REFERENCES SUBMISSION(pk_submission)
ON DELETE RESTRICT;

UPDATE TRANSACTION t
JOIN INGESTION i ON t.fk_ingestion  = i.pk_ingestion
SET t.fk_submission = i.fk_submission ;

ALTER TABLE MERCHANT
ADD UNIQUE KEY `unique_esercente_intermediario_submission` (`id_esercente`, `id_intermediario`, `fk_submission`);

ALTER TABLE TRANSACTION
ADD CONSTRAINT `fk_esercente_intermediario_submission`
FOREIGN KEY (`id_esercente`, `id_intermediario`, `fk_submission`)
REFERENCES MERCHANT (`id_esercente`, `id_intermediario`, `fk_submission`);

ALTER TABLE TRANSACTION
DROP FOREIGN KEY fk_esercente_intermediario;

ALTER TABLE MERCHANT
DROP CONSTRAINT unique_esercente_intermediario;

ALTER TABLE MERCHANT
MODIFY COLUMN fk_submission BIGINT NOT NULL;

ALTER TABLE TRANSACTION
MODIFY COLUMN fk_submission BIGINT NOT NULL;

CREATE TABLE `ERROR_CAUSE` (
	`pk_error_cause` BIGINT PRIMARY KEY AUTO_INCREMENT,
	`fk_error_record` BIGINT,
	`fk_error_type` BIGINT NOT NULL,
	`error_message` VARCHAR(2500),
	FOREIGN KEY (fk_error_record) REFERENCES `ERROR_RECORD`(`pk_error_record`),
	FOREIGN KEY (fk_error_type) REFERENCES `ERROR_TYPE`(pk_error_type)
)

ALTER TABLE ERROR_RECORD
	DROP FOREIGN KEY ERROR_RECORD_ibfk_2,
    DROP COLUMN error_message,
    DROP COLUMN fk_error_type;


ALTER TABLE ERROR_RECORD
ADD COLUMN fk_submission BIGINT NULL;

UPDATE ERROR_RECORD er
JOIN INGESTION i ON er.fk_ingestion = i.pk_ingestion
SET er.fk_submission = i.fk_submission;

ALTER TABLE ERROR_RECORD
MODIFY COLUMN fk_submission BIGINT NOT NULL;

ALTER TABLE ERROR_CAUSE
ADD COLUMN fk_submission BIGINT NULL;

UPDATE ERROR_CAUSE ec
JOIN ERROR_RECORD er ON ec.fk_error_record  = er.pk_error_record
JOIN INGESTION i ON er.fk_ingestion = i.pk_ingestion
SET ec.fk_submission = i.fk_submission;

ALTER TABLE ERROR_CAUSE
MODIFY COLUMN fk_submission BIGINT NOT NULL;

CREATE TABLE `RESOLVED_TRANSACTION` (
  `pk_resolved_transaction` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `fk_ingestion` BIGINT,
  `fk_submission` BIGINT,
  `tp_rec` VARCHAR(1),
  `id_intermediario` varchar(11),
  `id_esercente` varchar(30),
  `chiave_banca` varchar(50),
  `id_pos` varchar(30),
  `tipo_ope` varchar(2),
  `dt_ope` INT,
  `divisa_ope` varchar(3),
  `tipo_pag` varchar(2),
  `imp_ope` decimal(14,2),
  `tot_ope` INT,
  FOREIGN KEY (`fk_ingestion`) REFERENCES `INGESTION`(`pk_ingestion`),
  FOREIGN KEY (`fk_submission`) REFERENCES `SUBMISSION`(`pk_submission`),
  UNIQUE KEY resolved_transaction_unique (id_esercente, chiave_banca, id_pos, tipo_ope, dt_ope, divisa_ope));

ALTER TABLE `RESOLVED_TRANSACTION`
ADD COLUMN created_at DATETIME NULL;

ALTER TABLE TRANSACTION
MODIFY COLUMN dt_ope VARCHAR(8) NULL;

ALTER TABLE posappdb.`RESOLVED_TRANSACTION`
ADD COLUMN fk_output BIGINT NULL,
ADD CONSTRAINT OUTPUT_RESOLVED_FK
    FOREIGN KEY (fk_output)
    REFERENCES OUTPUT_FILE(pk_output);

ALTER TABLE RESOLVED_TRANSACTION
ADD COLUMN fk_current_submission BIGINT NULL,
ADD CONSTRAINT CURRENT_SUBMISSION_FK
    FOREIGN KEY (fk_current_submission)
    REFERENCES SUBMISSION(pk_submission);