# ===================================================================
# Spring Boot configuration for the "local" profile.
#
# This configuration overrides the application.yml file.
# Used for local development with MySQL database.
# ===================================================================

# JVM arguments for Java 21 compatibility
# Add these to your IDE run configuration or Maven command
# --add-opens java.base/java.lang=ALL-UNNAMED
# --add-opens java.base/java.util=ALL-UNNAMED

# ===================================================================
# Standard Spring Boot properties.
# Full reference is available at:
# http://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html
# ===================================================================

logging:
    #    config: file:logback-spring.xml
    config: classpath:logback-spring.xml
    # Production logging: Reduce SQL log noise
    level:
        root: INFO
        it.deloitte.postrxade: INFO  # INFO level - statistics and important events
        it.deloitte.postrxade.parser.transaction: WARN  # Only warnings/errors for parsing details
        it.deloitte.postrxade.service.impl.ObligationServiceImpl: INFO  # Keep statistics visible
        org.hibernate.SQL: WARN  # Disable SQL query logging in production (too verbose)
        org.hibernate.type.descriptor.sql.BasicBinder: WARN  # Disable SQL parameter binding logs

management:
    endpoints:
        web:
            base-path: /private-monitor
            exposure:
                include: ['configprops', 'env', 'health', 'info', 'logfile', 'loggers', 'prometheus', 'threaddump', 'caches']
    endpoint:
        health:
            show-details: always
            probes:
                enabled: true
    health:
        group:
            liveness:
                include: livenessState
            readiness:
                include: readinessState

spring:
    application:
        name: pos-trx-ade

    datasource:
        type: com.zaxxer.hikari.HikariDataSource
        # MySQL AWS RDS Database for local development
        url: jdbc:mysql://sbx-nexi-db.c7a4uas6kdzy.eu-central-1.rds.amazonaws.com:3306/sbxnexidb?useSSL=true&serverTimezone=UTC&allowPublicKeyRetrieval=true
        username: posappdb
        password: GNEMOBY
        driverClassName: com.mysql.cj.jdbc.Driver
        hikari:
            poolName: Hikari
            auto-commit: false
            data-source-properties:
                cachePrepStmts: true
                prepStmtCacheSize: 250
                prepStmtCacheSqlLimit: 2048
                useServerPrepStmts: true

        # H2 Database for development (commented out)
        # url: jdbc:h2:mem:posdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
        # username: sa
        # password:
        # driverClassName: org.h2.Driver

    jpa:
        open-in-view: false
        show-sql: true
        hibernate:
            ddl-auto: update
            naming:
                physical-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
                implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyLegacyJpaImpl
        properties:
            hibernate.dialect: org.hibernate.dialect.MySQL8Dialect
            hibernate.default_schema: sbxnexidb
            hibernate.jdbc.time_zone: UTC
            hibernate.id.new_generator_mappings: true
            hibernate.connection.provider_disables_autocommit: true
            hibernate.cache.use_second_level_cache: false
            hibernate.cache.use_query_cache: false
            hibernate.format_sql: true
            hibernate.generate_statistics: false
            hibernate.jdbc.batch_size: 25
            hibernate.order_inserts: true
            hibernate.order_updates: true
            hibernate.jdbc.fetch_size: 150
            hibernate.criteria.literal_handling_mode: BIND
            hibernate.query.fail_on_pagination_over_collection_fetch: true
            hibernate.query.in_clause_parameter_padding: true
            hibernate.hbm2ddl.auto: update
            hibernate.hbm2ddl.import_files: /sql/schema.sql

    jmx:
        enabled: false

    main:
        allow-bean-definition-overriding: true
        banner-mode: 'off'

    messages:
        basename: i18n/messages

    mvc:
        favicon:
            enabled: false

    security:
        oauth2:
            client:
                provider:
                    oidc:
                        authorization-uri: https://intapi.nexi.it/nexiauth/oauth/openid/v2/authorize
                        token-uri: https://intapi.nexi.local:8443/nexiauth/oauth/openid/v2/token
                        jwk-set-uri: https://intapi.nexi.local:8443/nexi/.well-known/jwks.json
                    oidc-azure:
                        authorization-uri: https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/authorize
                        token-uri: https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/token
                        jwk-set-uri: https://login.microsoftonline.com/${AZURE_TENANT_ID}/discovery/v2.0/keys

                registration:
                    oidc:
                        client-id: 2f5bd3fa-d7e3-4f7a-bb7b-b52c9feb2d84
                        client-secret: d4fb54a7-a896-44f1-932e-97453eae3d1d
                        scope: openid,profile
                        redirect-uri: http://localhost:8080/api/login/oauth2/code/oidc
                        client-authentication-method: post
                        authorization-grant-type: authorization_code
                    oidc-azure:
                        provider: oidc-azure
                        client-id: ${AZURE_CLIENT_ID}
                        client-secret: ${AZURE_CLIENT_SECRET}
                        scope: openid,profile
                        redirect-uri: ${BE_BASE_URL}/api/login/oauth2/code/oidc-azure
                        client-authentication-method: post
                        authorization-grant-type: authorization_code

    session:
        store-type: jdbc
        jdbc:
            table-name: SPRING_SESSION
            initialize-schema: always

    task:
        execution:
            thread-name-prefix: pos-task-
            pool:
                core-size: 2
                max-size: 50
                queue-capacity: 10000
        scheduling:
            thread-name-prefix: pos-scheduling-
            pool:
                size: 2

    thymeleaf:
        mode: HTML

    output:
        ansi:
            console-available: true
    servlet:
        multipart:
            enabled: true
            file-size-threshold: 2KB
            max-file-size: 200MB
            max-request-size: 215MB
    docker:
        compose:
            enabled: false


springdoc:
    api-docs:
        path: /api/docs/api-docs
    swagger-ui:
        path: /api/docs/index.html
        operations-sorter: alpha

server:
    compression:
        enabled: true
        mime-types: text/html,text/xml,text/plain,text/css,application/javascript,application/json
        min-response-size: 1024
    error:
        include-message: always
    port: 8082
    servlet:
        session:
            cookie:
                http-only: true
            timeout: 3600

# ===================================================================
# Application specific properties
# ===================================================================
application:
    authority:
        info-env: 'PRD'
    http:
        header-name: ${spring.application.name}
    cors:
        allowed-origins: 'http://localhost:8080'
        allowed-methods: '*'
        allowed-headers: '*'
        exposed-headers: 'Authorization,Link,X-Total-Count,X-${application.http.header-name}-alert,X-${application.http.header-name}-error,X-${application.http.header-name}-params'
        allow-credentials: true
        max-age: 1800
    rest:
        tracing-request:
            enabled: true
    security:
        local-sso-workaround-enabled: false
        xsfr:
            enabled: true
            cookie-path: /

# Docker Compose disabled - using external MySQL database
# Alternative: Set system property -Dspring.docker.compose.enabled=false
